<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Mensagens - TravelFlow">
  <title>Mensagens - TravelFlow</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/dashboard.css">
</head>
<body>
  <div class="dashboard-layout">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <a href="dashboard.html" class="sidebar-logo">
          <div class="sidebar-logo-icon">✈️</div>
          <span class="sidebar-logo-text">TravelFlow</span>
        </a>
      </div>

      <nav class="sidebar-nav">
        <ul class="sidebar-menu">
          <li class="sidebar-menu-item">
            <a href="dashboard.html" class="sidebar-link">
              <span class="sidebar-icon">📊</span>
              <span>Dashboard</span>
            </a>
          </li>
          <li class="sidebar-menu-item">
            <a href="pacotes.html" class="sidebar-link">
              <span class="sidebar-icon">📦</span>
              <span>Pacotes</span>
            </a>
          </li>
          <li class="sidebar-menu-item">
            <a href="clientes.html" class="sidebar-link">
              <span class="sidebar-icon">👥</span>
              <span>Clientes</span>
            </a>
          </li>
          <li class="sidebar-menu-item">
            <a href="reservas.html" class="sidebar-link">
              <span class="sidebar-icon">🎫</span>
              <span>Reservas</span>
            </a>
          </li>
          <li class="sidebar-menu-item">
            <a href="calendario.html" class="sidebar-link">
              <span class="sidebar-icon">📅</span>
              <span>Calendário</span>
            </a>
          </li>
          <li class="sidebar-menu-item">
            <a href="mensagens.html" class="sidebar-link active">
              <span class="sidebar-icon">💬</span>
              <span>Mensagens</span>
            </a>
          </li>
          <li class="sidebar-menu-item">
            <a href="relatorios.html" class="sidebar-link">
              <span class="sidebar-icon">📈</span>
              <span>Relatórios</span>
            </a>
          </li>
          <li class="sidebar-menu-item">
            <a href="configuracoes.html" class="sidebar-link">
              <span class="sidebar-icon">⚙️</span>
              <span>Configurações</span>
            </a>
          </li>
        </ul>
      </nav>

      <div class="sidebar-footer">
        <div class="sidebar-user" id="userInfo">
          <div class="sidebar-user-avatar" id="userAvatar">U</div>
          <div class="sidebar-user-info">
            <span class="sidebar-user-name" id="userName">Usuário</span>
            <span class="sidebar-user-role" id="userRole">Carregando...</span>
          </div>
        </div>
      </div>
    </aside>

    <!-- Overlay para mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Topbar -->
      <header class="topbar">
        <div class="topbar-left">
          <button class="menu-toggle-btn" id="menuToggle" aria-label="Menu">
            ☰
          </button>
          
          <h2 style="margin: 0; font-size: var(--font-size-xl);">Mensagens</h2>
        </div>

        <div class="topbar-right">
          <button class="topbar-icon-btn" aria-label="Notificações">
            🔔
            <span class="notification-badge">3</span>
          </button>
          <button class="topbar-icon-btn" aria-label="Nova Mensagem" onclick="newMessage()">
            ✏️
          </button>
          <a href="login.html" class="topbar-icon-btn" aria-label="Sair" title="Sair">
            🚪
          </a>
        </div>
      </header>

      <!-- Content Area -->
      <div class="content-area">
        <div class="messages-layout">
          <!-- Conversations Panel -->
          <div class="conversations-panel" id="conversationsPanel">
            <div class="conversations-header">
              <h3 style="margin: 0;">Conversas</h3>
              <div class="conversations-search">
                <span class="conversations-search-icon">🔍</span>
                <input type="search" placeholder="Buscar conversas..." id="searchConversations">
              </div>
            </div>

            <div class="conversations-list" id="conversationsList">
              <!-- Conversations will be generated by JavaScript -->
            </div>
          </div>

          <!-- Chat Panel -->
          <div class="chat-panel" id="chatPanel">
            <div id="chatContent">
              <!-- Chat content will be loaded here -->
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    // Verificar autenticação
    function checkAuth() {
      const user = localStorage.getItem('travelflow_user');
      if (!user) {
        window.location.href = 'login.html';
        return null;
      }
      return JSON.parse(user);
    }

    // Carregar informações do usuário
    function loadUserInfo() {
      const user = checkAuth();
      if (!user) return;

      document.getElementById('userName').textContent = user.name || user.email.split('@')[0];
      document.getElementById('userRole').textContent = user.role === 'admin' ? 'Administrador' : 'Usuário';
      document.getElementById('userAvatar').textContent = (user.name || user.email).substring(0, 2).toUpperCase();
    }

    // Menu Toggle
    const menuToggle = document.getElementById('menuToggle');
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebarOverlay');

    menuToggle.addEventListener('click', () => {
      sidebar.classList.toggle('active');
      sidebarOverlay.classList.toggle('active');
    });

    sidebarOverlay.addEventListener('click', () => {
      sidebar.classList.remove('active');
      sidebarOverlay.classList.remove('active');
    });

    // Dados de conversas simuladas
    const conversations = [
      {
        id: 1,
        name: 'Maria Santos',
        avatar: 'MS',
        lastMessage: 'Obrigada pelas informações sobre Maragogi!',
        time: '10:30',
        unread: 2,
        messages: [
          { sender: 'Maria Santos', text: 'Olá! Gostaria de mais informações sobre o pacote de Maragogi.', time: '09:15', sent: false },
          { sender: 'Você', text: 'Olá Maria! Claro, o pacote inclui 7 dias com hospedagem, café da manhã e passeios às piscinas naturais.', time: '09:20', sent: true },
          { sender: 'Maria Santos', text: 'Perfeito! E qual o valor total?', time: '09:25', sent: false },
          { sender: 'Você', text: 'O valor é R$ 2.499 por pessoa. Temos uma promoção especial este mês!', time: '09:28', sent: true },
          { sender: 'Maria Santos', text: 'Obrigada pelas informações sobre Maragogi!', time: '10:30', sent: false }
        ]
      },
      {
        id: 2,
        name: 'Carlos Oliveira',
        avatar: 'CO',
        lastMessage: 'Quando sai o voucher?',
        time: 'Ontem',
        unread: 0,
        messages: [
          { sender: 'Carlos Oliveira', text: 'Bom dia! Confirmei o pagamento da viagem para Europa.', time: 'Ontem 14:20', sent: false },
          { sender: 'Você', text: 'Ótimo Carlos! Já recebi a confirmação do pagamento.', time: 'Ontem 14:25', sent: true },
          { sender: 'Carlos Oliveira', text: 'Quando sai o voucher?', time: 'Ontem 14:30', sent: false }
        ]
      },
      {
        id: 3,
        name: 'Ana Paula Costa',
        avatar: 'AP',
        lastMessage: 'Preciso reagendar a viagem',
        time: '2 dias',
        unread: 1,
        messages: [
          { sender: 'Ana Paula Costa', text: 'Oi! Tive um imprevisto no trabalho.', time: '2 dias 16:00', sent: false },
          { sender: 'Ana Paula Costa', text: 'Preciso reagendar a viagem', time: '2 dias 16:05', sent: false }
        ]
      },
      {
        id: 4,
        name: 'Roberto Silva',
        avatar: 'RS',
        lastMessage: 'Você: Enviado! Verifique seu e-mail.',
        time: '3 dias',
        unread: 0,
        messages: [
          { sender: 'Roberto Silva', text: 'Pode me enviar o roteiro detalhado?', time: '3 dias 11:00', sent: false },
          { sender: 'Você', text: 'Enviado! Verifique seu e-mail.', time: '3 dias 11:15', sent: true }
        ]
      },
      {
        id: 5,
        name: 'Juliana Mendes',
        avatar: 'JM',
        lastMessage: 'Adorei as opções!',
        time: '1 semana',
        unread: 0,
        messages: [
          { sender: 'Juliana Mendes', text: 'Quais pacotes vocês têm para lua de mel?', time: '1 semana 10:00', sent: false },
          { sender: 'Você', text: 'Temos várias opções! Caribe, Maldivas, Grécia...', time: '1 semana 10:30', sent: true },
          { sender: 'Juliana Mendes', text: 'Adorei as opções!', time: '1 semana 11:00', sent: false }
        ]
      }
    ];

    let activeConversation = null;

    function renderConversations() {
      const list = document.getElementById('conversationsList');
      list.innerHTML = '';

      conversations.forEach(conv => {
        const item = document.createElement('div');
        item.className = `conversation-item ${conv.unread > 0 ? 'unread' : ''} ${activeConversation === conv.id ? 'active' : ''}`;
        item.onclick = () => openConversation(conv.id);

        item.innerHTML = `
          <div class="conversation-avatar">${conv.avatar}</div>
          <div class="conversation-info">
            <div class="conversation-header">
              <span class="conversation-name">${conv.name}</span>
              <span class="conversation-time">${conv.time}</span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <p class="conversation-preview">${conv.lastMessage}</p>
              ${conv.unread > 0 ? `<span class="unread-badge">${conv.unread}</span>` : ''}
            </div>
          </div>
        `;

        list.appendChild(item);
      });
    }

    function openConversation(id) {
      activeConversation = id;
      const conv = conversations.find(c => c.id === id);
      
      if (!conv) return;

      // Marcar como lida
      conv.unread = 0;
      renderConversations();

      const chatContent = document.getElementById('chatContent');
      
      let messagesHTML = '';
      conv.messages.forEach(msg => {
        messagesHTML += `
          <div class="message ${msg.sent ? 'sent' : ''}">
            <div class="message-avatar">${msg.sent ? 'VC' : conv.avatar}</div>
            <div class="message-content">
              <div class="message-bubble">
                <p class="message-text">${msg.text}</p>
              </div>
              <div class="message-time">${msg.time}</div>
            </div>
          </div>
        `;
      });

      chatContent.innerHTML = `
        <div class="chat-header">
          <div class="chat-header-info">
            <div class="chat-header-avatar">${conv.avatar}</div>
            <div class="chat-header-details">
              <h3>${conv.name}</h3>
              <p>Online agora</p>
            </div>
          </div>
          <div class="chat-actions">
            <button class="btn btn-ghost btn-sm" onclick="viewClientProfile(${id})">👤 Perfil</button>
            <button class="btn btn-ghost btn-sm" onclick="viewReservations(${id})">🎫 Reservas</button>
          </div>
        </div>

        <div class="chat-messages" id="chatMessages">
          ${messagesHTML}
        </div>

        <div class="chat-input-area">
          <div class="chat-input-wrapper">
            <button class="btn btn-ghost" onclick="attachFile()">📎</button>
            <textarea class="chat-input" id="messageInput" placeholder="Digite sua mensagem..." rows="1"></textarea>
            <button class="btn btn-primary" onclick="sendMessage()">Enviar</button>
          </div>
        </div>
      `;

      // Scroll to bottom
      setTimeout(() => {
        const messagesDiv = document.getElementById('chatMessages');
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }, 100);

      // Auto-resize textarea
      const textarea = document.getElementById('messageInput');
      textarea.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
      });

      // Send on Enter
      textarea.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
    }

    function sendMessage() {
      const input = document.getElementById('messageInput');
      const text = input.value.trim();
      
      if (!text) return;

      const conv = conversations.find(c => c.id === activeConversation);
      if (!conv) return;

      const now = new Date();
      const time = `${now.getHours()}:${String(now.getMinutes()).padStart(2, '0')}`;

      conv.messages.push({
        sender: 'Você',
        text: text,
        time: time,
        sent: true
      });

      conv.lastMessage = `Você: ${text}`;
      conv.time = time;

      input.value = '';
      input.style.height = 'auto';
      
      openConversation(activeConversation);
      renderConversations();
    }

    function newMessage() {
      alert('💬 Nova Mensagem\n\nSelecione um cliente para iniciar uma conversa:\n\n• Maria Santos\n• Carlos Oliveira\n• Ana Paula Costa\n• Roberto Silva\n• Juliana Mendes');
    }

    function viewClientProfile(id) {
      alert(`👤 Visualizando perfil do cliente\n\nEm produção, isso abriria:\n• Dados pessoais\n• Histórico de viagens\n• Preferências\n• Documentos`);
    }

    function viewReservations(id) {
      alert(`🎫 Reservas do cliente\n\nEm produção, isso mostraria:\n• Reservas ativas\n• Histórico de reservas\n• Pagamentos\n• Vouchers`);
    }

    function attachFile() {
      alert('📎 Anexar arquivo\n\nFormatos aceitos:\n• Imagens (JPG, PNG)\n• Documentos (PDF, DOC)\n• Planilhas (XLS, CSV)');
    }

    // Busca
    document.getElementById('searchConversations').addEventListener('input', function(e) {
      const query = e.target.value.toLowerCase();
      const items = document.querySelectorAll('.conversation-item');
      
      items.forEach(item => {
        const name = item.querySelector('.conversation-name').textContent.toLowerCase();
        const message = item.querySelector('.conversation-preview').textContent.toLowerCase();
        
        if (name.includes(query) || message.includes(query)) {
          item.style.display = 'flex';
        } else {
          item.style.display = 'none';
        }
      });
    });

    // Logout
    document.querySelectorAll('.topbar-icon-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        if (btn.getAttribute('aria-label') === 'Sair') {
          e.preventDefault();
          if (confirm('Deseja realmente sair?')) {
            localStorage.removeItem('travelflow_user');
            window.location.href = 'login.html';
          }
        }
      });
    });

    // Mostrar estado vazio inicialmente
    function showEmptyState() {
      document.getElementById('chatContent').innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">💬</div>
          <h3>Selecione uma conversa</h3>
          <p>Escolha uma conversa da lista para começar a enviar mensagens</p>
        </div>
      `;
    }

    // Inicializar
    loadUserInfo();
    renderConversations();
    showEmptyState();
  </script>
</body>
</html>
